<!DOCTYPE html>
<html>
<head>
    <title>Selective Subscription Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 6px; }
        .section h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; margin-right: 10px; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .peer-cache { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .cached-peer { padding: 15px; border: 2px solid #007bff; border-radius: 6px; background: #e7f3ff; }
        .cached-peer.selected { border-color: #28a745; background: #d4edda; }
        .cached-peer h4 { margin: 0 0 8px 0; color: #333; }
        .cached-peer p { margin: 4px 0; font-size: 12px; color: #666; }
        .peer-actions { margin-top: 10px; display: flex; gap: 5px; }
        .peer-actions button { padding: 5px 10px; font-size: 12px; margin: 0; }
        .token-container { margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6; }
        .token-display { display: flex; align-items: center; gap: 5px; }
        .token-text { font-family: monospace; font-size: 10px; color: #495057; word-break: break-all; flex: 1; max-height: 40px; overflow-y: auto; }
        .copy-btn { padding: 4px 8px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .copy-btn:hover { background: #0056b3; }
        .copy-btn.copied { background: #28a745; }
        .subscription-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .subscription-source, .subscription-targets { padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; }
        .subscription-targets h3 { margin-top: 0; }
        .target-peer { padding: 12px; border: 1px solid #ddd; margin: 10px 0; border-radius: 4px; background: white; }
        .target-peer h4 { margin: 0 0 10px 0; color: #333; }
        .track-list { margin-top: 8px; }
        .error { color: #dc3545; margin-top: 10px; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; }
        .success { color: #155724; margin-top: 10px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; }
        .info { color: #004085; margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêü Selective Subscription Demo</h1>
        
        <div class="section">
            <h2>Create Peers</h2>
            <div class="form-group">
                <label for="peerName">Peer Name:</label>
                <input type="text" id="peerName" placeholder="Enter peer name">
            </div>
            <button onclick="createPeer()">‚ûï Create Peer</button>
        </div>

        <div class="section">
            <h2>Cached Peers</h2>
            <div id="cachedPeersContainer" class="peer-cache">
                <div class="empty-state"><p>No peers created yet. Create a peer to get started!</p></div>
            </div>
        </div>

        <div class="section">
            <h2>Subscription Management</h2>
            <div id="subscriptionPanel">
                <div class="info">Select a source peer from the cached peers above to manage subscriptions.</div>
            </div>
        </div>

        <div id="message"></div>
    </div>

    <script>
        let cachedPeers = [];
        let selectedSourcePeer = null;

        async function createPeer() {
            const peerName = document.getElementById('peerName').value.trim();
            if (!peerName) return showMessage('Please enter a peer name', 'error');
            
            try {
                const response = await fetch('/api/peers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_name: 'default-room', peer_name: peerName })
                });
                const data = await response.json();
                
                if (response.ok) {
                    cachedPeers.push({
                        id: data.peer_id,
                        name: peerName,
                        token: data.token,
                        createdAt: new Date().toISOString()
                    });
                    renderCachedPeers();
                    document.getElementById('peerName').value = '';
                    showMessage(`Peer "${peerName}" created successfully!`, 'success');
                } else {
                    showMessage(data.error || 'Failed to create peer', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function renderCachedPeers() {
            const container = document.getElementById('cachedPeersContainer');
            if (cachedPeers.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No peers created yet.</p></div>';
                return;
            }

            container.innerHTML = cachedPeers.map(peer => `
                <div class="cached-peer ${selectedSourcePeer?.id === peer.id ? 'selected' : ''}">
                    <h4>${peer.name}</h4>
                    <p><strong>ID:</strong> ${peer.id.substring(0, 8)}...</p>
                    <p><strong>Created:</strong> ${new Date(peer.createdAt).toLocaleTimeString()}</p>
                    <div class="token-container">
                        <p style="margin: 0 0 4px 0; font-size: 11px; font-weight: bold; color: #666;">Token:</p>
                        <div class="token-display">
                            <div class="token-text">${peer.token}</div>
                            <button class="copy-btn" onclick="copyToken('${peer.id}', this)">üìã Copy</button>
                        </div>
                    </div>
                    <div class="peer-actions">
                        <button class="success" onclick="selectSourcePeer('${peer.id}')">
                            ${selectedSourcePeer?.id === peer.id ? '‚úì Selected' : 'Select'}
                        </button>
                        <button class="danger" onclick="deletePeer('${peer.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function selectSourcePeer(peerId) {
            const peer = cachedPeers.find(p => p.id === peerId);
            if (!peer) return;
            selectedSourcePeer = peer;
            renderCachedPeers();
            renderSubscriptionPanel();
            showMessage(`Selected "${peer.name}" as source peer`, 'info');
        }

        function deletePeer(peerId) {
            if (!confirm('Delete this peer?')) return;
            cachedPeers = cachedPeers.filter(p => p.id !== peerId);
            if (selectedSourcePeer?.id === peerId) selectedSourcePeer = null;
            renderCachedPeers();
            renderSubscriptionPanel();
            showMessage('Peer deleted', 'success');
        }

        function copyToken(peerId, btn) {
            const peer = cachedPeers.find(p => p.id === peerId);
            if (!peer) return;
            navigator.clipboard.writeText(peer.token).then(() => {
                btn.textContent = '‚úì Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã Copy';
                    btn.classList.remove('copied');
                }, 2000);
                showMessage('Token copied!', 'success');
            }).catch(err => showMessage('Failed to copy: ' + err.message, 'error'));
        }

        function renderSubscriptionPanel() {
            const panel = document.getElementById('subscriptionPanel');
            if (!selectedSourcePeer) {
                panel.innerHTML = '<div class="info">Select a source peer above.</div>';
                return;
            }

            const targetPeers = cachedPeers.filter(p => p.id !== selectedSourcePeer.id);
            if (targetPeers.length === 0) {
                panel.innerHTML = `<div class="subscription-source"><h3>Source: ${selectedSourcePeer.name}</h3><p>Create more peers to enable subscriptions.</p></div>`;
                return;
            }

            panel.innerHTML = `
                <div class="subscription-panel">
                    <div class="subscription-source">
                        <h3>Source Peer</h3>
                        <div class="target-peer">
                            <h4>${selectedSourcePeer.name}</h4>
                            <p><strong>ID:</strong> ${selectedSourcePeer.id}</p>
                        </div>
                        <button onclick="renderSubscriptionPanel()" class="secondary">üîÑ Refresh</button>
                    </div>
                    <div class="subscription-targets">
                        <h3>Available Target Peers</h3>
                        ${targetPeers.map(peer => `
                            <div class="target-peer">
                                <h4>${peer.name}</h4>
                                <p><strong>ID:</strong> ${peer.id}</p>
                                <div class="track-list">
                                    <p><strong>Subscribe to entire peer:</strong></p>
                                    <button onclick="subscribePeer('${peer.id}')" style="width: 100%; margin-bottom: 15px;">Subscribe to All Tracks</button>
                                    <p style="margin-top: 12px;"><strong>Or specific tracks:</strong></p>
                                    <input type="text" id="tracks-${peer.id}" placeholder="track-1, track-2" style="margin-bottom: 8px;">
                                    <button onclick="subscribeTracks('${peer.id}')" style="width: 100%;">Subscribe to Tracks</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function subscribePeer(targetPeerId) {
            if (!selectedSourcePeer) return showMessage('No source peer', 'error');
            try {
                const response = await fetch('/api/subscribe_peer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ peer_id: selectedSourcePeer.id, target_peer_id: targetPeerId })
                });
                const data = await response.json();
                if (response.ok) {
                    const target = cachedPeers.find(p => p.id === targetPeerId);
                    showMessage(`Subscribed "${selectedSourcePeer.name}" to "${target?.name}"`, 'success');
                } else {
                    showMessage(data.error || 'Failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function subscribeTracks(targetPeerId) {
            if (!selectedSourcePeer) return showMessage('No source peer', 'error');
            const input = document.getElementById(`tracks-${targetPeerId}`);
            const value = input.value.trim();
            if (!value) return showMessage('Enter track IDs', 'error');
            
            const trackIds = value.split(',').map(id => id.trim()).filter(id => id);
            if (trackIds.length === 0) return showMessage('Enter valid track IDs', 'error');

            try {
                const response = await fetch('/api/subscribe_tracks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ peer_id: selectedSourcePeer.id, track_ids: trackIds })
                });
                const data = await response.json();
                if (response.ok) {
                    const target = cachedPeers.find(p => p.id === targetPeerId);
                    showMessage(`Subscribed to ${trackIds.length} track(s) from "${target?.name}"`, 'success');
                    input.value = '';
                } else {
                    showMessage(data.error || 'Failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = type;
            setTimeout(() => { msg.textContent = ''; msg.className = ''; }, 5000);
        }
    </script>
</body>
</html>
